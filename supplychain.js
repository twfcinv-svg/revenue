(function(){
  const URL_VER = Date.now(); // always force fresh fetch
  const XLSX_FILE = new URL(`./data.xlsx?v=${URL_VER}`, location.href).toString();
  const SHEET_NODES='ChainNodes', SHEET_LINKS='ChainLinks', SHEET_STOCKS='ChainStocks', SHEET_REVENUE='Revenue';
  const svg = d3.select('#sc-svg');
  const listEl = document.querySelector('#sc-stock-list');
  const listTitle = document.querySelector('#sc-list-title');
  const state = { inited:false, nodes:[], links:[], stocksByStage:new Map(), stockToStages:new Map(), revenueRows:[], colMap:{}, months:[], byCodeName:new Map(), sim:null, nodeSel:null, linkSel:null };
  document.addEventListener('DOMContentLoaded', async()=>{ try{ const wb=await loadWorkbook(); buildData(wb); buildChart(); bindExternalControls(); state.inited=true; } catch(e){ console.error(e); if(svg.node()) svg.append('text').attr('x',20).attr('y',30).attr('fill','#e11d48').text('ä¾›æ‡‰éˆè³‡æ–™è¼‰å…¥å¤±æ•—ï¼š'+e.message); } });
  async function loadWorkbook(){ const r=await fetch(XLSX_FILE,{cache:'no-store'}); if(!r.ok) throw new Error('è®€å– data.xlsx å¤±æ•—ï¼ˆHTTP '+r.status+'ï¼‰'); const buf=await r.arrayBuffer(); return XLSX.read(buf,{type:'array'}); }
  const COL_RE={ YoY:/^(\d{4})[\/å¹´-]?\s*(\d{1,2})\s*å–®æœˆåˆä½µç‡Ÿæ”¶\s*å¹´[æˆå¢]é•·\s*[\(ï¼ˆ]?(?:%|ï¼…)[\)ï¼‰]?$/i, MoM:/^(\d{4})[\/å¹´-]?\s*(\d{1,2})\s*å–®æœˆåˆä½µç‡Ÿæ”¶\s*æœˆ[è®Šå¢]å‹•\s*[\(ï¼ˆ]?(?:%|ï¼…)[\)ï¼‰]?$/i };
  function toHalfWidth(s){ return String(s||'').replace(/[ï¼-ï¼™ï¼¡-ï¼ºï½-ï½š]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)); }
  function normText(s){ return String(s==null?'':s).replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\u3000/g,' ').replace(/\s+/g,' ').trim(); }
  function normCode(s){ return toHalfWidth(String(s||'')).replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,'').trim(); }
  function displayPct(v){ if(v==null||!isFinite(v)) return 'â€”'; const s=v.toFixed(1)+'%'; return v>=0?('+'+s):s; }
  function buildData(wb){ const wsN=wb.Sheets[SHEET_NODES], wsL=wb.Sheets[SHEET_LINKS], wsS=wb.Sheets[SHEET_STOCKS], wsR=wb.Sheets[SHEET_REVENUE]; if(!wsN||!wsL||!wsS) throw new Error('ç¼ºå°‘å·¥ä½œè¡¨ï¼š'+[!wsN&&SHEET_NODES,!wsL&&SHEET_LINKS,!wsS&&SHEET_STOCKS].filter(Boolean).join(',')); if(wsR){ const rowsHeader=XLSX.utils.sheet_to_json(wsR,{header:1,blankrows:false}); const header=Array.isArray(rowsHeader)&&rowsHeader.length?rowsHeader[0]:[]; const found=new Set(); const colMap={}; header.forEach(raw=>{ if(!raw) return; const h=normText(String(raw)); let m=h.match(COL_RE.YoY); if(m){ const ym=m[1]+String(m[2]).padStart(2,'0'); (colMap[ym]??={}).YoY=raw; found.add(ym); return;} m=h.match(COL_RE.MoM); if(m){ const ym=m[1]+String(m[2]).padStart(2,'0'); (colMap[ym]??={}).MoM=raw; found.add(ym);} }); state.colMap=colMap; state.months=Array.from(found).sort((a,b)=>b.localeCompare(a)); state.revenueRows=XLSX.utils.sheet_to_json(wsR,{defval:null}); const CODE_FIELDS=['å€‹è‚¡','ä»£è™Ÿ','è‚¡ç¥¨ä»£ç¢¼','è‚¡ç¥¨ä»£è™Ÿ','å…¬å¸ä»£è™Ÿ','è­‰åˆ¸ä»£è™Ÿ']; const NAME_FIELDS=['åç¨±','å…¬å¸åç¨±','è­‰åˆ¸åç¨±']; const sample=state.revenueRows[0]||{}; const codeKey=CODE_FIELDS.find(k=>k in sample)||CODE_FIELDS[0]; const nameKey=NAME_FIELDS.find(k=>k in sample)||NAME_FIELDS[0]; state.revenueRows.forEach(r=>{ const code=normCode(r[codeKey]); const name=normText(r[nameKey]); if(code) state.byCodeName.set(code,name); }); }
    state.nodes = XLSX.utils.sheet_to_json(wsN,{defval:null}).map(r=>({id:Number(r['ç¯€é»ID']), name:String(r['åç¨±']||''), order:Number(r['é †åº']||r['ç¯€é»ID'])})).filter(d=>Number.isFinite(d.id)&&d.name);
    state.links = XLSX.utils.sheet_to_json(wsL,{defval:null}).map(r=>({source:Number(r['source']), target:Number(r['target'])})).filter(e=>Number.isFinite(e.source)&&Number.isFinite(e.target));
    const stocksByStage=new Map(), stockToStages=new Map();
    XLSX.utils.sheet_to_json(wsS,{defval:null}).forEach(r=>{ const sid=Number(r['ç¯€é»ID']); const code=normCode(r['å€‹è‚¡']); let name=normText(r['åç¨±']||''); if(!name&&code&&state.byCodeName.has(code)) name=state.byCodeName.get(code); if(!Number.isFinite(sid)||!code) return; if(!stocksByStage.has(sid)) stocksByStage.set(sid,[]); stocksByStage.get(sid).push({code,name}); if(!stockToStages.has(code)) stockToStages.set(code,[]); stockToStages.get(code).push(sid); });
    state.stocksByStage=stocksByStage; state.stockToStages=stockToStages; }
  function getMetricValueByCode(code, month, metric){ const row=state.revenueRows.find(r=>{ const v=r['å€‹è‚¡']??r['ä»£è™Ÿ']??r['è‚¡ç¥¨ä»£ç¢¼']??r['è‚¡ç¥¨ä»£è™Ÿ']??r['å…¬å¸ä»£è™Ÿ']??r['è­‰åˆ¸ä»£è™Ÿ']; return normCode(v)===code; }); if(!row||!month||!metric) return null; const col=(state.colMap[month]||{})[metric]; if(!col) return null; let v=row[col]; if(v==null||v==='') return null; if(typeof v==='string') v=v.replace('%','').replace('ï¼…','').trim(); v=Number(v); return Number.isFinite(v)?v:null; }
  function buildChart(){ svg.selectAll('*').remove(); svg.append('defs').append('marker').attr('id','sc-arrow').attr('viewBox','0 -5 10 10').attr('refX',22).attr('refY',0).attr('markerWidth',6).attr('markerHeight',6).attr('orient','auto').append('path').attr('d','M0,-5L10,0L0,5').attr('fill','#bdbdbd'); const g=svg.append('g').attr('class','sc-g'); const linkSel=g.selectAll('.sc-link').data(state.links).enter().append('line').attr('class','sc-link'); const nodeSel=g.selectAll('.sc-node').data(state.nodes).enter().append('g').attr('class','sc-node').on('click',(_,d)=>{ highlightStages([d.id]); renderListForStage(d.id); }).call(d3.drag().on('start',(ev,d)=>{ if(!ev.active) state.sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }).on('drag',(ev,d)=>{ d.fx=ev.x; d.fy=ev.y; }).on('end',(ev,d)=>{ if(!ev.active) state.sim.alphaTarget(0); d.fx=null; d.fy=null; })); nodeSel.append('circle').attr('r',22); nodeSel.append('text').attr('text-anchor','middle').attr('dy',-32).text(d=>d.name); const xScale=d3.scaleLinear().domain(d3.extent(state.nodes,d=>d.order)).range([80,920]); state.sim=d3.forceSimulation(state.nodes).force('link',d3.forceLink(state.links).id(d=>d.id).distance(120)).force('charge',d3.forceManyBody().strength(-450)).force('center',d3.forceCenter(500,310)).force('x',d3.forceX(d=>xScale(d.order)).strength(0.45)).force('y',d3.forceY(310).strength(0.06)); state.sim.on('tick',()=>{ linkSel.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y); nodeSel.attr('transform',d=>`translate(${d.x},${d.y})`); }); state.nodeSel=nodeSel; state.linkSel=linkSel; const firstId=state.nodes[0]?.id; if(firstId!=null) renderListForStage(firstId); }
  function renderListForStage(stageId){ const month=document.querySelector('#monthSelect')?.value || state.months[0] || null; const metric=document.querySelector('#metricSelect')?.value || 'MoM'; const list=state.stocksByStage.get(stageId)||[]; listTitle.textContent='ğŸ“Œ '+(state.nodes.find(n=>n.id===stageId)?.name||'é¸æ“‡ç¯€é»')+'ï¼šç›¸é—œæ¦‚å¿µè‚¡'; if(list.length===0){ listEl.innerHTML='<li>ï¼ˆæ­¤ç¯€é»å°šç„¡è³‡æ–™ï¼‰</li>'; return; } const enriched=list.map(s=>({ ...s, v:getMetricValueByCode(s.code, month, metric) })).sort((a,b)=>((b.v==null?-Infinity:b.v)-(a.v==null?-Infinity:a.v))); listEl.innerHTML=enriched.map(s=>{ const pct=s.v==null?'â€”':displayPct(s.v); return `<li><span class="code">${s.code}</span><span>${(s.name||'')}</span><span class="chip">${month?(`${month.slice(0,4)}/${month.slice(4,6)}`:'--')} Â· ${metric}</span><span style="margin-left:6px;">${pct}</span><button data-code="${s.code}" title="ä»¥æ­¤å€‹è‚¡ç‚ºä¸»è§’">æŸ¥çœ‹</button></li>`; }).join(''); listEl.querySelectorAll('button[data-code]').forEach(btn=>{ btn.addEventListener('click',()=>{ const code=btn.getAttribute('data-code'); window.dispatchEvent(new CustomEvent('stockSelected',{detail:{code}})); }); }); }
  function highlightStages(stageIds){ const set=new Set(stageIds||[]); state.nodeSel.classed('highlight', d=> set.has(d.id)); state.linkSel.attr('stroke', d=> (set.has(d.source.id)||set.has(d.target.id)) ? '#666' : '#bdbdbd').attr('stroke-width', d=> (set.has(d.source.id)||set.has(d.target.id)) ? 3 : 1.5); }
  function bindExternalControls(){ ['monthSelect','metricSelect'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change',()=>{ const highlighted=document.querySelector('.sc-node.highlight')?._data?.id ?? state.nodes[0]?.id; if(highlighted!=null) renderListForStage(highlighted); }, {passive:true}); }); state.nodeSel?.each(function(d){ this._data=d; }); }
  function updateSupplyChainByTicker(code){ if(!state.inited) return; const stages=state.stockToStages.get(code)||[]; highlightStages(stages); if(stages.length>0) renderListForStage(stages[0]); document.getElementById('sc-section')||document.getElementById('supplychain')?.scrollIntoView({behavior:'smooth', block:'start'}); }
  window.updateSupplyChainByTicker = updateSupplyChainByTicker;
})();
