<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>產業平均成長幅度 → Treemap 面積</title>
  <style>
    :root {
      --bg: #0f172a;          /* 深色背景 */
      --panel: #111827;       /* 面板底色 */
      --text: #e5e7eb;        /* 主文字 */
      --muted: #9ca3af;       /* 淺文字 */
      --accent: #22d3ee;      /* 強調色 */
      --border: #374151;      /* 邊框 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans TC, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px; flex-wrap: wrap;
      border-bottom: 1px solid var(--border); background: rgba(17, 24, 39, 0.7);
      position: sticky; top: 0; backdrop-filter: blur(6px); z-index: 5;
    }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; color: var(--text); }
    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .toolbar label { font-size: 13px; color: var(--muted); }
    select, button {
      background: var(--panel); color: var(--text); border: 1px solid var(--border);
      border-radius: 8px; padding: 6px 10px; font-size: 13px;
    }
    button:hover, select:hover { border-color: #4b5563; }
    .note { margin-left: auto; font-size: 12px; color: var(--muted); }
    #chart { width: 100%; height: calc(100vh - 64px); padding: 12px; }
    #chart > div { border-radius: 12px; }
    .footer { padding: 12px 16px; border-top: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .link { color: var(--accent); text-decoration: none; }
  </style>
  <!-- ECharts 5 -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- SheetJS (xlsx) → 讀取 Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Treemap：類股面積 = 類股平均成長幅度（可切換 MoM / YoY）</h1>
    <div class="toolbar">
      <label for="metricSelect">面積依據</label>
      <select id="metricSelect">
        <option value="mom" selected>平均 MoM（%）</option>
        <option value="yoy">平均 YoY（%）</option>
      </select>
      <button id="reloadBtn">重新載入 Excel</button>
    </div>
    <div class="note">
      讀取檔案：<code>data.xlsx</code>（放同一資料夾）
    </div>
  </header>

  <div id="chart"></div>

  <div class="footer">
    提示：若在本地直接用瀏覽器開啟 HTML 讀取不到 Excel，請改用 GitHub Pages 或本機開一個靜態伺服器（例如 <code>python -m http.server</code>）。
  </div>

  <script>
  // ==== 小工具：字串轉數字 percent 或數值 → 浮點數（單位：%） ====
  function toNumber(v) {
    if (v == null) return NaN;
    if (typeof v === 'number') return v;
    const s = String(v).trim();
    if (s === '' || s === '-' || s.toLowerCase() === 'nan') return NaN;
    // 移除逗點與百分比符號
    const cleaned = s.replace(/,/g, '').replace(/%/g, '');
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }

  // 可能的欄位名稱（盡量容錯）
  const FIELD_CANDIDATES = {
    code: ['代號','股票代號','證券代號','code','ticker'],
    name: ['名稱','公司','名稱(公司)','name'],
    category: ['類股','產業','族群','category','industry','group'],
    mom: ['MoM','mom','月增','月增率','近月MoM','近月MoM(%)'],
    yoy: ['YoY','yoy','年增','年增率','近月YoY','近月YoY(%)']
  };

  function findField(obj, names) {
    const keys = Object.keys(obj);
    for (const n of names) {
      const k = keys.find(kk => kk.toLowerCase() === String(n).toLowerCase());
      if (k) return k;
    }
    // 寫法不同（去空白、全形/半形/大小寫差異）
    for (const n of names) {
      const target = n.toLowerCase().replace(/\s+/g, '');
      const k = keys.find(kk => kk.toLowerCase().replace(/\s+/g, '') === target);
      if (k) return k;
    }
    return null;
  }

  async function loadExcelArray() {
    const res = await fetch('data.xlsx');
    if (!res.ok) throw new Error('讀取 data.xlsx 失敗：' + res.status);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    // 嘗試找第一個非空工作表
    const sheetName = wb.SheetNames.find(n => wb.Sheets[n] && Object.keys(wb.Sheets[n]).length > 0);
    if (!sheetName) throw new Error('Excel 沒有可用工作表');
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
    return rows;
  }

  function groupBy(arr, keyFn) {
    const m = new Map();
    for (const item of arr) {
      const k = keyFn(item);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(item);
    }
    return m;
  }

  // 主邏輯：把 Excel 轉成 ECharts treemap 所需的 data 結構
  function buildTreemapData(rows, metricKey) {
    if (!rows.length) throw new Error('Excel 無資料列');
    // 自動偵測欄位
    const fieldMap = {};
    for (const f in FIELD_CANDIDATES) {
      fieldMap[f] = findField(rows[0], FIELD_CANDIDATES[f]);
    }
    if (!fieldMap.category) throw new Error('找不到「類股/產業/族群」欄位');
    if (!fieldMap.code || !fieldMap.name) throw new Error('找不到「代號」或「名稱」欄位');
    if (!fieldMap[metricKey]) throw new Error('找不到指定的成長欄位：' + metricKey);

    // 清洗資料
    const stocks = rows.map(r => ({
      code: r[fieldMap.code],
      name: r[fieldMap.name],
      category: r[fieldMap.category],
      mom: toNumber(r[fieldMap.mom]),
      yoy: toNumber(r[fieldMap.yoy])
    })).filter(s => s.category != null && s.name != null && s.code != null);

    const metricGetter = (s) => metricKey === 'mom' ? s.mom : s.yoy;

    // 依類股分組並計算平均
    const byCat = groupBy(stocks, s => s.category);
    const cats = [];
    for (const [cat, items] of byCat.entries()) {
      const vals = items.map(metricGetter).filter(v => Number.isFinite(v));
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : NaN;
      // 子節點：個股，用於顯示與（可選）內層面積
      const children = items.map(s => {
        const g = metricGetter(s);
        const childWeight = (Number.isFinite(g) ? Math.abs(g) : 0) + 1e-6; // 避免 0 面積看不到
        return {
          name: `${s.code} ${s.name} ${Number.isFinite(g) ? (g>=0?'+':'')+g.toFixed(1)+'%' : ''}`,
          // value 第一維 = 面積，第二維 = 用於顏色的成長率
          value: [childWeight, Number.isFinite(g) ? g : 0],
          label: { overflow: 'break' }
        };
      });
      cats.push({ name: cat, avgGrowth: avg, children });
    }

    // 轉成非負權重以決定「類股」面積（保序：最大平均 → 最大面積；最小/負值 → 最小面積）
    const validAvgs = cats.map(d => d.avgGrowth).filter(v => Number.isFinite(v));
    const minAvg = validAvgs.length ? Math.min(...validAvgs) : 0;
    const eps = 1e-6;

    // 同時算出顏色映射上下限
    const maxAvg = validAvgs.length ? Math.max(...validAvgs) : 0;
    const colorMin = Math.min(minAvg, -Math.abs(maxAvg));
    const colorMax = Math.max(maxAvg,  Math.abs(minAvg));

    const data = cats.map(d => {
      const weight = (Number.isFinite(d.avgGrowth) ? (d.avgGrowth - minAvg) : 0) + eps;
      const displayAvgStr = Number.isFinite(d.avgGrowth) ? (d.avgGrowth>=0?'+':'') + d.avgGrowth.toFixed(1) + '%' : 'N/A';
      return {
        name: `${d.name} 平均：${displayAvgStr}`,
        // 類股方塊：第一維（面積）= 平移後權重；第二維（顏色）= 真實平均值
        value: [weight, Number.isFinite(d.avgGrowth) ? d.avgGrowth : 0],
        children: d.children,
        upperLabel: { show: true }
      };
    });

    // 依平均值由大到小排序（不影響面積計算，但讓版面更直觀）
    data.sort((a, b) => b.value[1] - a.value[1]);

    return { data, colorMin, colorMax };
  }

  function renderTreemap({ data, colorMin, colorMax }) {
    const dom = document.getElementById('chart');
    const chart = echarts.init(dom, null, { renderer: 'canvas' });

    const option = {
      backgroundColor: 'transparent',
      tooltip: {
        formatter: function (info) {
          const treePathInfo = info.treePathInfo;
          const treePath = [];
          for (let i = 1; i < treePathInfo.length; i++) {
            treePath.push(treePathInfo[i].name);
          }
          const growth = Array.isArray(info.value) ? info.value[1] : info.value;
          return `<div style="font-size:12px;line-height:1.4">
            <div style="color:#9ca3af">${echarts.format.encodeHTML(treePath.join(' / '))}</div>
            <div>成長：<b>${(growth>=0?'+':'') + growth.toFixed(1)}%</b></div>
            <div style="color:#9ca3af">面積依據：類股平均（已平移，保序）</div>
          </div>`;
        }
      },
      visualMap: [{
        type: 'continuous',
        min: colorMin, max: colorMax,
        // 維度 1：顏色映射（維度 0 用於面積）
        dimension: 1,
        inRange: {
          color: ['#16a34a', '#f59e0b', '#b91c1c'] // 負 → 綠、中性 → 黃、正 → 紅
        },
        text: ['高成長', '低/負成長'],
        textStyle: { color: '#d1d5db' },
        itemHeight: 160,
        calculable: true,
        orient: 'vertical',
        right: 10,
        top: 20
      }],
      series: [{
        type: 'treemap',
        roam: false,
        nodeClick: false,
        width: '100%',
        height: '100%',
        label: { show: true, color: '#e5e7eb', fontSize: 12 },
        upperLabel: { show: true, height: 26, color: '#e5e7eb', fontWeight: 600 },
        itemStyle: {
          borderColor: '#0b1220',
          borderWidth: 2,
          gapWidth: 6,
          borderRadius: 10
        },
        levels: [
          { // 類股層
            itemStyle: { borderWidth: 2, gapWidth: 6, borderRadius: 10 }
          },
          { // 個股層
            itemStyle: { borderWidth: 1, gapWidth: 4, borderRadius: 8 }
          }
        ],
        data
      }]
    };

    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
    return chart;
  }

  let chartInstance = null;

  async function boot(metricKey) {
    const rows = await loadExcelArray();
    const packed = buildTreemapData(rows, metricKey);
    if (chartInstance) chartInstance.dispose();
    chartInstance = renderTreemap(packed);
  }

  // UI 綁定
  const metricSelect = document.getElementById('metricSelect');
  const reloadBtn = document.getElementById('reloadBtn');
  metricSelect.addEventListener('change', () => boot(metricSelect.value));
  reloadBtn.addEventListener('click', () => boot(metricSelect.value));

  // 初始載入（預設用 MoM）
  boot('mom').catch(err => {
    console.error(err);
    const dom = document.getElementById('chart');
    dom.innerHTML = `<div style="padding:16px;color:#fecaca;background:#7f1d1d;border:1px solid #ef4444;border-radius:8px;">讀檔或繪圖發生錯誤：${err.message}</div>`;
  });
  </script>
</body>
</html>